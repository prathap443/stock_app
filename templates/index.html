<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analytics - Prathap's Analysis</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Stock Analytics - Prathap's Analysis</h1>
            <p>Real-time analysis of top market performers</p>
            <p id="last-updated">Last updated: <span id="last-updated-time"></span></p>
        </header>

        <!-- Scrolling News Ticker -->
        <div class="news-ticker">
            <div id="news-ticker-content">
                <!-- News items will be populated by JavaScript -->
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary">
            <div class="summary-item buy">
                <h3>BUY</h3>
                <p id="buy-count">0</p>
            </div>
            <div class="summary-item hold">
                <h3>HOLD</h3>
                <p id="hold-count">0</p>
            </div>
            <div class="summary-item sell">
                <h3>SELL</h3>
                <p id="sell-count">0</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <input type="text" id="search" placeholder="Search stocks...">
            <select id="sector-filter">
                <option value="">All Sectors</option>
                <option value="Technology">Technology</option>
                <option value="Finance">Finance</option>
                <option value="Consumer Goods">Consumer Goods</option>
                <option value="Entertainment">Entertainment</option>
                <option value="Financial Services">Financial Services</option>
                <option value="Aerospace">Aerospace</option>
                <option value="Healthcare">Healthcare</option>
                <option value="Energy">Energy</option>
            </select>
            <button onclick="resetFilters()">Reset Filters</button>
            <button onclick="refreshData()" class="refresh-btn">Refresh</button>
        </div>

        <!-- Stock Cards -->
        <div class="stock-grid" id="stock-grid"></div>

        <!-- Modal for Detailed Stock Info -->
        <div id="stock-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <h2 id="modal-symbol"></h2>
                <div id="modal-details"></div>
            </div>
        </div>
    </div>

    <script>
        let stocksData = [];
        let allNews = [];

        // Fetch stock data
        async function fetchStockData() {
            try {
                const response = await fetch('/api/stocks');
                const data = await response.json();
                if (data.error) {
                    alert('Error fetching stock data: ' + data.error);
                    return;
                }
                stocksData = data.stocks;
                updateSummary(data.summary);
                document.getElementById('last-updated-time').textContent = data.last_updated;
                fetchNewsForAllStocks();
                renderStocks(stocksData);
            } catch (error) {
                console.error('Error fetching stock data:', error);
            }
        }

        // Fetch news for all stocks and populate the ticker
        async function fetchNewsForAllStocks() {
            allNews = [];
            for (const stock of stocksData) {
                try {
                    const response = await fetch(`/api/stock_news/${stock.symbol}`);
                    const news = await response.json();
                    if (news && !news.error) {
                        news.forEach(article => {
                            allNews.push(`${stock.symbol}: ${article.title} (${article.publisher})`);
                        });
                    }
                } catch (error) {
                    console.error(`Error fetching news for ${stock.symbol}:`, error);
                }
            }
            displayNewsTicker();
        }

        // Display news ticker
        function displayNewsTicker() {
            const tickerContent = document.getElementById('news-ticker-content');
            tickerContent.innerHTML = '';
            if (allNews.length === 0) {
                tickerContent.textContent = 'No news available.';
                return;
            }
            allNews.forEach((newsItem, index) => {
                const span = document.createElement('span');
                span.textContent = newsItem;
                span.classList.add('news-item');
                span.id = `news-item-${index}`;
                tickerContent.appendChild(span);
            });
        }

        // Update summary section
        function updateSummary(summary) {
            document.getElementById('buy-count').textContent = summary.BUY;
            document.getElementById('hold-count').textContent = summary.HOLD;
            document.getElementById('sell-count').textContent = summary.SELL;
        }

        // Render stock cards
        function renderStocks(stocks) {
            const stockGrid = document.getElementById('stock-grid');
            stockGrid.innerHTML = '';
            stocks.forEach(stock => {
                const card = document.createElement('div');
                card.classList.add('stock-card');
                card.onclick = () => showStockDetails(stock.symbol); // Add click event to show details
                card.innerHTML = `
                    <h3>${stock.symbol}</h3>
                    <p>${stock.name}</p>
                    <p class="${stock.recommendation.toLowerCase()}">${stock.percent_change_2w.toFixed(2)}%</p>
                    <p>${stock.recommendation}</p>
                    <p>$${stock.current_price.toFixed(2)}</p>
                    <p>Sentiment: ${stock.news_sentiment.toFixed(3)}</p>
                    <div class="chart-buttons">
                        <button onclick="renderChart('${stock.symbol}', '1D'); event.stopPropagation();">1D</button>
                        <button onclick="renderChart('${stock.symbol}', '1W'); event.stopPropagation();">1W</button>
                        <button onclick="renderChart('${stock.symbol}', '1M'); event.stopPropagation();">1M</button>
                    </div>
                    <canvas id="chart-${stock.symbol}"></canvas>
                    <button onclick="getLivePrediction('${stock.symbol}'); event.stopPropagation();">Get Live Prediction</button>
                    <button onclick="viewNews('${stock.symbol}'); event.stopPropagation();">View News</button>
                `;
                stockGrid.appendChild(card);
                renderChart(stock.symbol, '1D');
            });
        }

        // Show stock details in modal
        async function showStockDetails(symbol) {
            const stock = stocksData.find(s => s.symbol === symbol);
            if (!stock) return;

            document.getElementById('modal-symbol').textContent = stock.symbol;
            const modalDetails = document.getElementById('modal-details');
            modalDetails.innerHTML = `
                <h3>About</h3>
                <p>${stock.about || 'No description available.'}</p>
                <p><a href="#" onclick="alert('More details coming soon!'); return false;">Show more</a></p>
                <div class="stock-info">
                    <div>
                        <strong>CEO</strong>
                        <p>${stock.ceo || 'N/A'}</p>
                    </div>
                    <div>
                        <strong>Employees</strong>
                        <p>${stock.employees || 'N/A'}</p>
                    </div>
                    <div>
                        <strong>Headquarters</strong>
                        <p>${stock.headquarters || 'N/A'}</p>
                    </div>
                    <div>
                        <strong>Founded</strong>
                        <p>${stock.founded || 'N/A'}</p>
                    </div>
                </div>
                <h3>Key Statistics</h3>
                <div class="stock-stats">
                    <div>
                        <strong>Market cap</strong>
                        <p>${stock.market_cap ? (stock.market_cap / 1e9).toFixed(2) + 'B' : 'N/A'}</p>
                    </div>
                    <div>
                        <strong>Price-Earnings ratio</strong>
                        <p>${stock.pe_ratio ? stock.pe_ratio.toFixed(2) : 'N/A'}</p>
                    </div>
                    <div>
                        <strong>Dividend yield</strong>
                        <p>${stock.dividend_yield ? stock.dividend_yield.toFixed(2) + '%' : 'â€”'}</p>
                    </div>
                    <div>
                        <strong>Average volume</strong>
                        <p>${stock.avg_volume ? (stock.avg_volume / 1e6).toFixed(2) + 'M' : 'N/A'}</p>
                    </div>
                    <div>
                        <strong>High today</strong>
                        <p>${stock.high_today ? '$' + stock.high_today.toFixed(2) : 'N/A'}</p>
                    </div>
                    <div>
                        <strong>Low today</strong>
                        <p>${stock.low_today ? '$' + stock.low_today.toFixed(2) : 'N/A'}</p>
                    </div>
                    <div>
                        <strong>Open price</strong>
                        <p>${stock.open_price ? '$' + stock.open_price.toFixed(2) : 'N/A'}</p>
                    </div>
                    <div>
                        <strong>Volume</strong>
                        <p>${stock.volume ? (stock.volume / 1e6).toFixed(2) + 'M' : 'N/A'}</p>
                    </div>
                    <div>
                        <strong>52 Week high</strong>
                        <p>${stock.week_52_high ? '$' + stock.week_52_high.toFixed(2) : 'N/A'}</p>
                    </div>
                    <div>
                        <strong>52 Week low</strong>
                        <p>${stock.week_52_low ? '$' + stock.week_52_low.toFixed(2) : 'N/A'}</p>
                    </div>
                </div>
            `;
            document.getElementById('stock-modal').style.display = 'block';
        }

        // Close the modal
        function closeModal() {
            document.getElementById('stock-modal').style.display = 'none';
        }

        // Render chart for a stock
        async function renderChart(symbol, period) {
            try {
                const response = await fetch(`/api/stock_history/${symbol}/${period}`);
                const data = await response.json();
                if (data[0]?.error) {
                    console.error(data[0].error);
                    return;
                }
                const labels = data.map(item => item.date);
                const prices = data.map(item => item.close);
                const ctx = document.getElementById(`chart-${symbol}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${symbol} Price`,
                            data: prices,
                            borderColor: '#00C4B4',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { display: true },
                            y: { display: true }
                        }
                    }
                });
            } catch (error) {
                console.error(`Error rendering chart for ${symbol}:`, error);
            }
        }

        // Filter stocks
        function filterStocks() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const sector = document.getElementById('sector-filter').value;
            const filteredStocks = stocksData.filter(stock => {
                const matchesSearch = stock.symbol.toLowerCase().includes(searchTerm) || stock.name.toLowerCase().includes(searchTerm);
                const matchesSector = sector ? stock.sector === sector : true;
                return matchesSearch && matchesSector;
            });
            renderStocks(filteredStocks);
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('sector-filter').value = '';
            renderStocks(stocksData);
        }

        // Refresh data
        async function refreshData() {
            try {
                const response = await fetch('/api/refresh', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    fetchStockData();
                } else {
                    alert('Error refreshing data: ' + result.error);
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // Get live prediction
        async function getLivePrediction(symbol) {
            try {
                const response = await fetch(`/api/live_prediction/${symbol}`);
                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                alert(`Live Prediction for ${symbol}: ${data.recommendation}\nCurrent Price: $${data.current_price.toFixed(2)}\nChange Today: ${data.percent_change_today.toFixed(2)}%`);
            } catch (error) {
                console.error(`Error getting live prediction for ${symbol}:`, error);
            }
        }

        // View news
        async function viewNews(symbol) {
            try {
                const response = await fetch(`/api/stock_news/${symbol}`);
                const news = await response.json();
                if (news.error) {
                    alert('Error: ' + news.error);
                    return;
                }
                let newsContent = `News for ${symbol}:\n\n`;
                news.forEach(article => {
                    newsContent += `${article.title}\n${article.link}\n${article.publisher} - ${article.published_at}\n\n`;
                });
                alert(newsContent);
            } catch (error) {
                console.error(`Error fetching news for ${symbol}:`, error);
            }
        }

        // Event listeners for filters
        document.getElementById('search').addEventListener('input', filterStocks);
        document.getElementById('sector-filter').addEventListener('change', filterStocks);

        // Initial load
        fetchStockData();
    </script>
</body>
</html>